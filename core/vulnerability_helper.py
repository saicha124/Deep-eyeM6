"""
Vulnerability Helper
Helper functions for creating and enhancing vulnerability records
"""

from datetime import datetime
from typing import Dict


def create_vulnerability(
    vuln_type: str,
    severity: str,
    url: str,
    description: str,
    evidence: str,
    remediation: str,
    **kwargs
) -> Dict:
    """
    Create a vulnerability record with timestamp and standard fields.
    
    Args:
        vuln_type: Type of vulnerability (e.g., "SQL Injection")
        severity: Severity level (critical, high, medium, low, info)
        url: Vulnerable URL
        description: Description of the vulnerability
        evidence: Evidence of the vulnerability
        remediation: How to fix the vulnerability
        **kwargs: Additional fields (parameter, payload, cwe, etc.)
    
    Returns:
        Dictionary with vulnerability data including timestamp
    """
    vulnerability = {
        'type': vuln_type,
        'severity': severity.lower(),
        'url': url,
        'description': description,
        'evidence': evidence,
        'remediation': remediation,
        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
    }
    
    # Add optional fields
    if 'parameter' in kwargs:
        vulnerability['parameter'] = kwargs['parameter']
    if 'payload' in kwargs:
        vulnerability['payload'] = kwargs['payload']
    if 'cwe' in kwargs:
        vulnerability['cwe'] = kwargs['cwe']
    if 'plugin' in kwargs:
        vulnerability['plugin'] = kwargs['plugin']
    
    # Add any other custom fields
    for key, value in kwargs.items():
        if key not in vulnerability:
            vulnerability[key] = value
    
    return vulnerability


def add_timestamp_to_vulnerability(vulnerability: Dict) -> Dict:
    """
    Add timestamp to an existing vulnerability if it doesn't have one.
    
    Args:
        vulnerability: Vulnerability dictionary
        
    Returns:
        Vulnerability dictionary with timestamp
    """
    if 'timestamp' not in vulnerability:
        vulnerability['timestamp'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    return vulnerability


def add_timestamps_to_vulnerabilities(vulnerabilities: list) -> list:
    """
    Add timestamps to a list of vulnerabilities.
    
    Args:
        vulnerabilities: List of vulnerability dictionaries
        
    Returns:
        List of vulnerabilities with timestamps
    """
    return [add_timestamp_to_vulnerability(v) for v in vulnerabilities]
